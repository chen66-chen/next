'use client'

import React, { useState, useEffect, useRef } from 'react'

/**
 * æ¸—é€æµ‹è¯•ç»ˆç«¯ç»„ä»¶
 * æ¨¡æ‹ŸKali Linuxä¸­å¸¸ç”¨æ¸—é€æµ‹è¯•å·¥å…·çš„ä½¿ç”¨è¿‡ç¨‹å’Œè¾“å‡ºç»“æœ
 */
const PentestTerminal = () => {
  // ç»ˆç«¯è¾“å…¥çŠ¶æ€
  const [input, setInput] = useState('')
  
  // ç»ˆç«¯è¾“å‡ºå†å²
  const [output, setOutput] = useState<string[]>([
    'â”Œâ”€â”€(rootã‰¿kali)-[~]',
    'â”‚',
    'â”‚ ğŸ–¥ï¸ æ¸—é€æµ‹è¯•å·¥å…·æ¨¡æ‹Ÿç»ˆç«¯',
    'â”‚ ğŸ’¡ æç¤ºï¼šè¾“å…¥ "tools" æŸ¥çœ‹å¯ç”¨çš„æ¸—é€æµ‹è¯•å·¥å…·',
    'â”‚ âŒ¨ï¸ è¾“å…¥ "help" æŸ¥çœ‹åŸºç¡€å‘½ä»¤',
    'â”‚',
    'â””â”€# '
  ])
  
  // å½“å‰å·¥ä½œç›®å½•
  const [currentDir, setCurrentDir] = useState('~')
  
  // å½“å‰æç¤ºç¬¦
  const [prompt, setPrompt] = useState('â””â”€# ')
  
  // å¼•ç”¨DOMå…ƒç´ 
  const inputRef = useRef<HTMLInputElement>(null)
  const terminalRef = useRef<HTMLDivElement>(null)
  
  // å­˜å‚¨æ»šåŠ¨ä½ç½®é˜²æ­¢è‡ªåŠ¨æ»šåŠ¨
  const scrollPosRef = useRef(0)
  
  // ç»ˆç«¯æ¿€æ´»çŠ¶æ€
  const [isActive, setIsActive] = useState(false)
  
  // å®šä¹‰ç›®æ ‡ç³»ç»Ÿï¼Œç”¨äºæ¨¡æ‹Ÿæ‰«æç»“æœ
  const targetSystem = {
    ip: '192.168.1.100',
    hostname: 'target-server',
    os: 'Linux 4.18.0-305.el8.x86_64',
    ports: [
      { port: 22, service: 'ssh', state: 'open', version: 'OpenSSH 8.0' },
      { port: 80, service: 'http', state: 'open', version: 'Apache httpd 2.4.37' },
      { port: 443, service: 'https', state: 'open', version: 'Apache httpd 2.4.37' },
      { port: 3306, service: 'mysql', state: 'open', version: 'MySQL 8.0.26' },
      { port: 21, service: 'ftp', state: 'filtered', version: 'vsftpd 3.0.3' }
    ],
    vulnerabilities: [
      { id: 'CVE-2021-44228', name: 'Log4Shell', severity: 'Critical', description: 'Apache Log4j2 è¿œç¨‹ä»£ç æ‰§è¡Œæ¼æ´' },
      { id: 'CVE-2019-9517', name: 'HTTP/2 DoS', severity: 'High', description: 'HTTP/2å®ç°ä¸­çš„æ‹’ç»æœåŠ¡æ¼æ´' },
      { id: 'CVE-2018-1312', name: 'Apache HTTPD', severity: 'Medium', description: 'Apache HTTP Serverèº«ä»½éªŒè¯ç»•è¿‡æ¼æ´' }
    ]
  }
  
  // å®šä¹‰Metasploitæ¨¡å—
  const metasploitModules = [
    { path: 'exploit/multi/http/log4shell', cve: 'CVE-2021-44228', name: 'Apache Log4j2 RCE', rank: 'excellent' },
    { path: 'exploit/linux/http/apache_mod_cgi_bash_env_exec', cve: 'CVE-2014-6271', name: 'Shellshock', rank: 'excellent' },
    { path: 'exploit/unix/webapp/wp_admin_shell_upload', cve: 'N/A', name: 'WordPress Admin Shell Upload', rank: 'excellent' },
    { path: 'exploit/windows/smb/ms17_010_eternalblue', cve: 'CVE-2017-0143', name: 'EternalBlue SMB Remote', rank: 'great' },
    { path: 'exploit/linux/mysql/mysql_udf_payload', cve: 'N/A', name: 'MySQL UDF Payload', rank: 'excellent' }
  ]
  
  // ===== æ•ˆæœå¤„ç† =====
  
  // ä¿å­˜æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢è‡ªåŠ¨æ»šåŠ¨
  useEffect(() => {
    const saveScrollPosition = () => {
      scrollPosRef.current = window.scrollY
    }
    
    window.addEventListener('scroll', saveScrollPosition)
    return () => window.removeEventListener('scroll', saveScrollPosition)
  }, [])

  // è‡ªåŠ¨æ»šåŠ¨ç»ˆç«¯å†…å®¹åˆ°åº•éƒ¨ï¼Œä½†ä¸æ»šåŠ¨é¡µé¢
  useEffect(() => {
    if (terminalRef.current && isActive) {
      // ä»…åœ¨ç»ˆç«¯æ¿€æ´»çŠ¶æ€ä¸‹æ»šåŠ¨ç»ˆç«¯å†…å®¹
      terminalRef.current.scrollTop = terminalRef.current.scrollHeight
      
      // æ¢å¤é¡µé¢æ»šåŠ¨ä½ç½®ï¼Œé˜²æ­¢é¡µé¢æ»šåŠ¨
      requestAnimationFrame(() => {
        window.scrollTo({
          top: scrollPosRef.current,
          behavior: 'auto'
        })
      })
    }
  }, [output, isActive])
  
  // ===== äº‹ä»¶å¤„ç† =====
  
  /**
   * å¤„ç†é”®ç›˜æŒ‰é”®äº‹ä»¶
   * å½“ç”¨æˆ·æŒ‰ä¸‹Enteré”®æ—¶å¤„ç†å‘½ä»¤
   */
  const handleKeyDown = (e: React.KeyboardEvent) => {
    if (e.key === 'Enter') {
      // è®°å½•å½“å‰æ»šåŠ¨ä½ç½®
      scrollPosRef.current = window.scrollY
      
      processCommand()
      
      // é˜²æ­¢é¡µé¢æ»šåŠ¨
      e.preventDefault()
    }
  }

  /**
   * æ¿€æ´»ç»ˆç«¯å¹¶è·å–ç„¦ç‚¹
   * ä»…å½“ç”¨æˆ·ç‚¹å‡»ç»ˆç«¯åŒºåŸŸæ—¶
   */
  const activateTerminal = (e: React.MouseEvent) => {
    // è®°å½•ç‚¹å‡»å‰çš„æ»šåŠ¨ä½ç½®
    scrollPosRef.current = window.scrollY
    
    // é˜²æ­¢äº‹ä»¶å†’æ³¡
    e.stopPropagation()
    
    // è®¾ç½®ç»ˆç«¯ä¸ºæ¿€æ´»çŠ¶æ€
    setIsActive(true)
    
    // è·å–è¾“å…¥ç„¦ç‚¹
    if (inputRef.current) {
      inputRef.current.focus()
    }
    
    // æ¢å¤åŸå§‹æ»šåŠ¨ä½ç½®
    requestAnimationFrame(() => {
      window.scrollTo({
        top: scrollPosRef.current,
        behavior: 'auto'
      })
    })
  }

  /**
   * å»¶è¿Ÿè¾“å‡ºæ–‡æœ¬çš„è¾…åŠ©å‡½æ•°
   * æ¨¡æ‹Ÿé€è¡Œæ‰§è¡Œè¿‡ç¨‹
   */
  const typeOutput = (lines: string[], delay: number = 100, customPrompt: boolean = true) => {
    // åˆ›å»ºæœ€æ–°è¾“å‡ºï¼Œç§»é™¤æœ€åä¸€è¡Œæç¤ºç¬¦
    const newOutput = [...output.slice(0, -1), output[output.length - 1] + input.trim()]
    
    // æ·»åŠ æ–°çš„è¾“å‡ºè¡Œ
    lines.forEach((line, index) => {
      setTimeout(() => {
        setOutput(prev => [...prev, line])
      }, delay * (index + 1))
    })
    
    // æ·»åŠ æ–°çš„æç¤ºç¬¦
    if (customPrompt) {
      setTimeout(() => {
        setOutput(prev => [...prev, `â”Œâ”€â”€(rootã‰¿kali)-[${currentDir}]`, 'â””â”€# '])
      }, delay * (lines.length + 1))
    }
    
    // æ¸…ç©ºè¾“å…¥
    setInput('')
    
    // æ¢å¤é¡µé¢æ»šåŠ¨ä½ç½®
    requestAnimationFrame(() => {
      window.scrollTo({
        top: scrollPosRef.current,
        behavior: 'auto'
      })
    })
  }
  
  /**
   * å¤„ç†å‘½ä»¤è¾“å…¥
   * æ ¹æ®ä¸åŒå‘½ä»¤å±•ç¤ºç›¸åº”çš„è¾“å‡º
   */
  const processCommand = () => {
    const command = input.trim()
    const commandParts = command.split(' ')
    const mainCommand = commandParts[0]
    
    // ä¸å¤„ç†ç©ºå‘½ä»¤
    if (command === '') {
      const newOutput = [...output.slice(0, -1), output[output.length - 1] + command]
      setOutput([...newOutput, `â”Œâ”€â”€(rootã‰¿kali)-[${currentDir}]`, 'â””â”€# '])
      setInput('')
      return
    }
    
    // åˆ›å»ºæ–°çš„è¾“å‡ºå†…å®¹ï¼Œæ·»åŠ ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤
    const newOutput = [...output.slice(0, -1), output[output.length - 1] + command]
    
    // å¤„ç†åŸºæœ¬å‘½ä»¤
    if (command === 'clear') {
      setOutput([`â”Œâ”€â”€(rootã‰¿kali)-[${currentDir}]`, 'â””â”€# '])
      setInput('')
      return
    } else if (command === 'help') {
      // æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
      typeOutput([
        'åŸºç¡€å‘½ä»¤:',
        '  clear       - æ¸…å±',
        '  cd <dir>    - æ›´æ”¹ç›®å½•',
        '  ls          - åˆ—å‡ºæ–‡ä»¶',
        '  pwd         - æ˜¾ç¤ºå½“å‰ç›®å½•',
        '  tools       - æ˜¾ç¤ºå¯ç”¨æ¸—é€æµ‹è¯•å·¥å…·',
        '  help        - æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯',
        '',
        'æ¸—é€æµ‹è¯•å·¥å…·:',
        '  nmap <target>          - ç½‘ç»œæ‰«æå™¨',
        '  msfconsole             - Metasploit Framework',
        '  sqlmap --url <url>     - SQLæ³¨å…¥æ£€æµ‹å·¥å…·',
        '  dirb <url>             - Webç›®å½•æ‰«æå™¨',
        '  hydra -l user -P pass.txt <service> - å¯†ç ç ´è§£å·¥å…·'
      ])
    } else if (command === 'tools') {
      // æ˜¾ç¤ºå¯ç”¨å·¥å…·ä¿¡æ¯
      typeOutput([
        'å¯ç”¨æ¸—é€æµ‹è¯•å·¥å…·:',
        '',
        'ä¿¡æ¯æ”¶é›†:',
        '  nmap        - ç½‘ç»œæ‰«æå·¥å…·',
        '  whois       - åŸŸåä¿¡æ¯æŸ¥è¯¢',
        '  dig         - DNSæŸ¥è¯¢å·¥å…·',
        '  theHarvester - é‚®ç®±å’Œå­åŸŸåæ”¶é›†',
        '',
        'æ¼æ´æ‰«æä¸åˆ©ç”¨:',
        '  msfconsole  - Metasploit Frameworkæ§åˆ¶å°',
        '  searchsploit - æ¼æ´æ•°æ®åº“æœç´¢å·¥å…·',
        '  sqlmap      - SQLæ³¨å…¥è‡ªåŠ¨åŒ–å·¥å…·',
        '',
        'å¯†ç æ”»å‡»:',
        '  hydra       - åœ¨çº¿å¯†ç ç ´è§£å·¥å…·',
        '  john        - ç¦»çº¿å¯†ç ç ´è§£å·¥å…·',
        '  hashcat     - é«˜çº§å¯†ç ç ´è§£å·¥å…·',
        '',
        'ç½‘ç»œåº”ç”¨åˆ†æ:',
        '  burpsuite   - Webåº”ç”¨å®‰å…¨æµ‹è¯•',
        '  dirb        - Webç›®å½•æ‰«æå·¥å…·',
        '  nikto       - WebæœåŠ¡å™¨æ‰«æå·¥å…·',
        '',
        'ä½¿ç”¨ç¤ºä¾‹ï¼šå¯ä»¥å°è¯•è¿è¡Œ "nmap 192.168.1.100" æˆ– "msfconsole"'
      ])
    } else if (command === 'ls') {
      // åˆ—å‡ºæ–‡ä»¶
      typeOutput([
        'Desktop   Documents   Downloads   Music   Pictures   Videos   tools   targets.txt   scan-results'
      ])
    } else if (command === 'pwd') {
      // æ˜¾ç¤ºå½“å‰ç›®å½•
      typeOutput([
        `/home/kali/${currentDir === '~' ? '' : currentDir}`
      ])
    } else if (commandParts[0] === 'cd') {
      // æ›´æ”¹ç›®å½•
      const dir = commandParts[1] || '~'
      setCurrentDir(dir)
      typeOutput([`å·²åˆ‡æ¢åˆ° ${dir} ç›®å½•`])
    } 
    // å¤„ç†æ¸—é€æµ‹è¯•å·¥å…·å‘½ä»¤
    else if (commandParts[0] === 'nmap') {
      // å¤„ç†nmapæ‰«æå‘½ä»¤
      const target = commandParts[1] || '127.0.0.1'
      
      // ç®€å•å‚æ•°æ£€æŸ¥
      if (commandParts.includes('-h') || commandParts.includes('--help')) {
        typeOutput([
          'Nmap 7.92 ( https://nmap.org )',
          'ç”¨æ³•: nmap [æ‰«æç±»å‹] [é€‰é¡¹] {ç›®æ ‡è§„èŒƒ}',
          'æ‰«æç±»å‹:',
          '  -sS/sT: TCP SYN/Connect() æ‰«æ',
          '  -sU: UDP æ‰«æ',
          '  -sV: ç‰ˆæœ¬æ£€æµ‹',
          '  -O: æ“ä½œç³»ç»Ÿæ£€æµ‹',
          '  -A: å¯ç”¨OSæ£€æµ‹ã€ç‰ˆæœ¬æ£€æµ‹ã€è„šæœ¬æ‰«æå’Œtraceroute',
          'é€‰é¡¹:',
          '  -p <ç«¯å£èŒƒå›´>: ä»…æ‰«ææŒ‡å®šçš„ç«¯å£',
          '  -T<0-5>: è®¾ç½®æ—¶é—´æ¨¡æ¿ (è¶Šé«˜è¶Šå¿«)',
          '  -v: å¢åŠ è¯¦ç»†çº§åˆ«'
        ])
        return
      }
      
      // æ¨¡æ‹Ÿ nmap æ‰«æè¿‡ç¨‹
      typeOutput([
        `æ­£åœ¨å¯åŠ¨å¯¹ ${target} çš„ Nmap æ‰«æ...`,
        'æ‰«æä¸­...'
      ], 500, false)
      
      setTimeout(() => {
        if (target === targetSystem.ip || target === targetSystem.hostname) {
          // æ˜¾ç¤ºç›®æ ‡ç³»ç»Ÿçš„æ‰«æç»“æœ
          const scanResults = [
            `Nmap æ‰«ææŠ¥å‘Š - ${targetSystem.ip} (${targetSystem.hostname})`,
            `ä¸»æœºå·²å¯åŠ¨ (å»¶è¿Ÿ: 0.015s)`,
            `æ“ä½œç³»ç»Ÿ: ${targetSystem.os}`,
            'ç«¯å£çŠ¶æ€:',
            `PORT     STATE    SERVICE     VERSION`
          ]
          
          // æ·»åŠ ç«¯å£ä¿¡æ¯
          targetSystem.ports.forEach(port => {
            scanResults.push(`${port.port}/tcp  ${port.state.padEnd(8)}${port.service.padEnd(12)}${port.version}`)
          })
          
          scanResults.push('')
          scanResults.push('æ‰«æå®Œæˆ: åœ¨ 1.45 ç§’å†…æ‰«æäº† 1000 ä¸ªTCPç«¯å£')
          
          // æ˜¾ç¤ºæ‰«æç»“æœ
          typeOutput(scanResults)
        } else {
          // ä¸€èˆ¬æ€§å“åº”
          typeOutput([
            `Nmap æ‰«ææŠ¥å‘Š - ${target}`,
            'ä¸»æœºä¼¼ä¹å·²å…³é—­ (æ²¡æœ‰æ”¶åˆ°å“åº”)',
            '',
            'æ‰«æå®Œæˆ: åœ¨ 0.82 ç§’å†…æ‰«æäº† 1000 ä¸ªTCPç«¯å£'
          ])
        }
      }, 3000)
    } else if (command === 'msfconsole' || (command.startsWith('msfconsole') && commandParts.length > 1)) {
      // æ¨¡æ‹Ÿ Metasploit å¯åŠ¨è¿‡ç¨‹
      typeOutput([
        'åˆå§‹åŒ– Metasploit Framework...',
        '',
        '    __ /--\\\\ \\\\  __   __ //-- \\\\__// --\\\\',
        '   /   \\\\  //--\\\\//--\\\\//--\\\\  //   // --//',
        '  /     \\\\//    //    //    \\\\//   //    \\\\'
      ], 100, false)
      
      setTimeout(() => {
        typeOutput([
          '',
          ' =[ metasploit v6.2.26-dev                          ]',
          '+ -- --=[ 2271 exploits - 1194 auxiliary - 406 post ]',
          '+ -- --=[ 948 payloads - 45 encoders - 11 nops      ]',
          '+ -- --=[ 9 evasion                                 ]',
          '',
          'Metasploit tip: Use sessions -1 to interact with the last opened session',
          '',
          'msf6 > '
        ], 50, false)
      }, 1500)
      
      if (commandParts.length > 1 && commandParts[1] === 'search') {
        const searchTerm = commandParts.slice(2).join(' ')
        
        setTimeout(() => {
          // æ¨¡æ‹Ÿæœç´¢ç»“æœ
          const results = [
            '',
            'Matching Modules',
            '================',
            '',
            '   #  Name                                        Disclosure Date  Rank       Check  Description',
            '   -  ----                                        ---------------  ----       -----  -----------'
          ]
          
          // è¿‡æ»¤åŒ¹é…çš„æ¨¡å—
          const matchedModules = metasploitModules.filter(module => 
            module.path.includes(searchTerm) || 
            module.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
            module.cve.includes(searchTerm)
          )
          
          if (matchedModules.length > 0) {
            matchedModules.forEach((module, idx) => {
              results.push(`   ${idx}  ${module.path.padEnd(42)} ${module.cve !== 'N/A' ? '2021-12-10' : '          '}  ${module.rank.padEnd(10)} Yes    ${module.name}`)
            })
          } else {
            results.push('æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡å—')
          }
          
          results.push('')
          results.push('msf6 > ')
          
          typeOutput(results, 50, false)
        }, 2000)
      } else if (commandParts.length > 1 && commandParts[1] === 'use') {
        const modulePath = commandParts.slice(2).join(' ')
        
        setTimeout(() => {
          const matchedModule = metasploitModules.find(m => m.path === modulePath)
          
          if (matchedModule) {
            typeOutput([
              `ä½¿ç”¨æ¼æ´æ¨¡å—: ${matchedModule.path}`,
              '',
              `msf6 exploit(${modulePath}) > `
            ], 50, false)
          } else {
            typeOutput([
              `æœªæ‰¾åˆ°æ¨¡å—: ${modulePath}`,
              '',
              'msf6 > '
            ], 50, false)
          }
        }, 1000)
      }
    } else if (commandParts[0] === 'sqlmap') {
      // æ¨¡æ‹Ÿ sqlmap å·¥å…·æ‰§è¡Œè¿‡ç¨‹
      if (commandParts.includes('--help') || commandParts.includes('-h')) {
        typeOutput([
          'sqlmap/1.6.12#stable',
          'ç”¨æ³•: python3 sqlmap.py [é€‰é¡¹]',
          '',
          'é€‰é¡¹:',
          '  -h, --help            æ˜¾ç¤ºåŸºæœ¬å¸®åŠ©ä¿¡æ¯å¹¶é€€å‡º',
          '  -u URL, --url=URL     ç›®æ ‡URL',
          '  --data=DATA           é€šè¿‡POSTå‘é€çš„æ•°æ®å­—ç¬¦ä¸²',
          '  --cookie=COOKIE       HTTP Cookieå¤´',
          '  --level=LEVEL         æ‰§è¡Œæµ‹è¯•çš„ç­‰çº§(1-5, é»˜è®¤ 1)',
          '  --risk=RISK           æ‰§è¡Œæµ‹è¯•çš„é£é™©(1-3, é»˜è®¤ 1)',
          '  --dbms=DBMS           å¼ºåˆ¶åç«¯DBMSä¸ºæŒ‡å®šå€¼',
          '  -p TESTPARAMETER      å¯æµ‹è¯•çš„å‚æ•°(s)',
          '  --current-user        è·å–DBMSå½“å‰ç”¨æˆ·',
          '  --passwords           æšä¸¾DBMSç”¨æˆ·å¯†ç å“ˆå¸Œ',
          '  --dbs                 æšä¸¾DBMSæ•°æ®åº“'
        ])
        return
      }
      
      // æ£€æŸ¥URLå‚æ•°æ˜¯å¦å­˜åœ¨
      const urlIdx = commandParts.indexOf('--url') !== -1 ? 
                    commandParts.indexOf('--url') + 1 : 
                    commandParts.indexOf('-u') !== -1 ?
                    commandParts.indexOf('-u') + 1 : -1
      
      if (urlIdx === -1 || urlIdx >= commandParts.length) {
        typeOutput([
          'é”™è¯¯: ç¼ºå°‘å¿…éœ€çš„å‚æ•° URL (--url æˆ– -u)',
          'ä½¿ç”¨ sqlmap --help æŸ¥çœ‹å¸®åŠ©'
        ])
        return
      }
      
      const targetUrl = commandParts[urlIdx]
      
      // æ¨¡æ‹Ÿ sqlmap æ‰§è¡Œè¿‡ç¨‹
      typeOutput([
        `sqlmap/1.6.12#stable`,
        `[*] å¼€å§‹åœ¨ ${new Date().toISOString().split('T')[0]} æ‰«æ`,
        `[21:45:25] [INFO] æµ‹è¯•è¿æ¥åˆ°ç›®æ ‡URL`,
        `[21:45:25] [INFO] æ­£åœ¨æ£€æµ‹åç«¯DBMS...`
      ], 300, false)
      
      setTimeout(() => {
        if (targetUrl.includes('vuln') || targetUrl.includes('test')) {
          typeOutput([
            `[21:45:28] [INFO] ç›®æ ‡URLç–‘ä¼¼å­˜åœ¨MySQLæ³¨å…¥æ¼æ´`,
            `[21:45:29] [INFO] æµ‹è¯•å‚æ•° 'id'`,
            `[21:45:30] [INFO] ç¡®è®¤MySQLæ•°æ®åº“`,
            `[21:45:31] [INFO] ç›®æ ‡ URL å‚æ•° 'id' å­˜åœ¨å¸ƒå°”å‹ç›²æ³¨æ¼æ´`,
            `[21:45:32] [WARNING] åœ¨æ¡ä»¶å“åº”ä¸­æ£€æµ‹åˆ°å¤§é‡ä¸åŒå€¼`,
            `[21:45:33] [INFO] å·²æ£€æµ‹æ¼æ´:`,
            `Parameter: id (GET)`,
            `    Type: boolean-based blind`,
            `    Title: AND boolean-based blind - WHERE or HAVING clause`,
            `    Payload: id=1 AND 7732=7732`,
            ``,
            `    Type: time-based blind`,
            `    Title: MySQL >= 5.0.12 time-based blind - Parameter replace`,
            `    Payload: id=(SELECT * FROM (SELECT(SLEEP(5)))hLIp)`,
            ``,
            `[21:45:34] [INFO] å·²ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶ ~/.local/share/sqlmap/output/${targetUrl.replace(/[^a-zA-Z0-9]/g, '_')}/`,
            '',
            '[*] æ‰«æå®Œæˆ'
          ], 200)
        } else {
          typeOutput([
            `[21:45:28] [INFO] æ£€æµ‹åç«¯DBMSä¸º MySQL`,
            `[21:45:30] [INFO] æµ‹è¯•å‚æ•° 'id'`,
            `[21:45:32] [INFO] åœ¨ç›®æ ‡URLå‚æ•° 'id' ä¸Šè¿›è¡Œæµ‹è¯•`,
            `[21:45:35] [WARNING] æ²¡æœ‰åœ¨æµ‹è¯•å‚æ•°ä¸­å‘ç°æ³¨å…¥ç‚¹`,
            `[21:45:36] [INFO] æµ‹è¯•å‚æ•° 'page'`,
            `[21:45:38] [INFO] åœ¨ç›®æ ‡URLä¸­æœªå‘ç°SQLæ³¨å…¥æ¼æ´`,
            `[21:45:39] [INFO] å·²ä¿å­˜æ—¥å¿—åˆ°æ–‡ä»¶ ~/.local/share/sqlmap/output/${targetUrl.replace(/[^a-zA-Z0-9]/g, '_')}/`,
            '',
            '[*] æ‰«æå®Œæˆ'
          ], 200)
        }
      }, 3000)
    } else if (commandParts[0] === 'dirb') {
      // æ¨¡æ‹Ÿdirbç½‘ç«™ç›®å½•æ‰«æ
      if (commandParts.length < 2) {
        typeOutput([
          'DIRB v2.22',
          'ç”¨æ³•: dirb <url> [è¯å…¸æ–‡ä»¶] [é€‰é¡¹]',
          '',
          'é€‰é¡¹:',
          '-a : æŒ‡å®šè‡ªå®šä¹‰ç”¨æˆ·ä»£ç†',
          '-c : è®¾ç½®cookie',
          '-r : ä¸ä½¿ç”¨é€’å½’æœç´¢',
          '-S : ä¸æ˜¾ç¤ºæµ‹è¯•çš„è¯',
          '-o <æ–‡ä»¶> : å°†è¾“å‡ºä¿å­˜åˆ°æ–‡ä»¶',
          '-w : æ£€æµ‹WebDAVæ”¯æŒ'
        ])
        return
      }
      
      const targetUrl = commandParts[1]
      
      typeOutput([
        'DIRB v2.22',
        `å¼€å§‹é’ˆå¯¹ ${targetUrl} çš„ç›®å½•æ‰«æ`,
        `ä½¿ç”¨è¯å…¸æ–‡ä»¶: /usr/share/dirb/wordlists/common.txt`,
        ''
      ], 100, false)
      
      // æ¨¡æ‹Ÿæ‰«æè¿‡ç¨‹
      setTimeout(() => {
        if (targetUrl.includes('test') || targetUrl.includes('dev')) {
          // æ¨¡æ‹Ÿå‘ç°æ•æ„Ÿç›®å½•çš„æƒ…å†µ
          typeOutput([
            'å‘ç°: /admin/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /backup/ (çŠ¶æ€ç : 403)',
            'å‘ç°: /config/ (çŠ¶æ€ç : 403)',
            'å‘ç°: /css/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /images/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /js/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /login.php (çŠ¶æ€ç : 200)',
            'å‘ç°: /phpmyadmin/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /test/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /upload.php (çŠ¶æ€ç : 200)',
            'å‘ç°: /wp-admin/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /wp-content/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /wp-login.php (çŠ¶æ€ç : 200)',
            '',
            'æ‰«æå®Œæˆ: å·²æµ‹è¯•4612ä¸ªè¯ï¼Œå‘ç°13ä¸ªç›®å½•/æ–‡ä»¶'
          ], 100)
        } else {
          // æ¨¡æ‹Ÿä¸€èˆ¬ç½‘ç«™
          typeOutput([
            'å‘ç°: /css/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /images/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /js/ (çŠ¶æ€ç : 301)',
            'å‘ç°: /index.php (çŠ¶æ€ç : 200)',
            'å‘ç°: /login.php (çŠ¶æ€ç : 200)',
            'å‘ç°: /robots.txt (çŠ¶æ€ç : 200)',
            '',
            'æ‰«æå®Œæˆ: å·²æµ‹è¯•4612ä¸ªè¯ï¼Œå‘ç°6ä¸ªç›®å½•/æ–‡ä»¶'
          ], 100)
        }
      }, 2500)
    } else if (commandParts[0] === 'hydra') {
      // æ¨¡æ‹Ÿhydraå¯†ç ç ´è§£
      if (commandParts.includes('-h') || commandParts.length < 4) {
        typeOutput([
          'Hydra v9.3 (c) 2022 by van Hauser/THC & David Maciejak',
          'ç”¨æ³•: hydra [[[-l LOGIN|-L FILE] [-p PASS|-P FILE]] | [-C FILE]] [-e nsr] [-o FILE] [-t TASKS] [-M FILE [-T TASKS]] [-w TIME] [-W TIME] [-f] [-s PORT] [-x MIN:MAX:CHARSET] [-c TIME] [-ISOuvVd46] [-m MODULE_OPT] [service://server[:PORT][/OPT]]',
          '',
          'é€‰é¡¹:',
          '  -l LOGIN æˆ– -L FILE  æŒ‡å®šç”¨æˆ·åæˆ–ç”¨æˆ·ååˆ—è¡¨æ–‡ä»¶',
          '  -p PASS æˆ– -P FILE   æŒ‡å®šå¯†ç æˆ–å¯†ç åˆ—è¡¨æ–‡ä»¶',
          '  -t TASKS  å¹¶è¡Œä»»åŠ¡æ•° (é»˜è®¤: 16)',
          '  -f  æ‰¾åˆ°ä¸€å¯¹ç™»å½•/å¯†ç ååœæ­¢çˆ†ç ´',
          '  -v / -V / -d  è¯¦ç»†æ¨¡å¼ / æ˜¾ç¤ºå°è¯• / è°ƒè¯•æ¨¡å¼',
          '',
          'æ”¯æŒçš„æœåŠ¡:',
          ' adam6500 asterisk cisco cisco-enable cvs firebird ftp[s] http[s]-{head|get|post} http[s]-{get|post}-form http-proxy http-proxy-urlenum icq imap[s] irc ldap2[s] ldap3[s]-crammd5 mssql mysql nntp oracle-listener oracle-sid pcanywhere pcnfs pop3[s] postgres radmin2 rdp redis rexec rlogin rpcap rsh rtsp s7-300 sip smb smtp[s] smtp-enum snmp socks5 ssh sshkey svn teamspeak telnet[s] vmauthd vnc xmpp'
        ])
        return
      }
      
      // æå–ç›®æ ‡å’ŒæœåŠ¡
      let service = 'ssh'  // é»˜è®¤æœåŠ¡
      let target = '127.0.0.1'  // é»˜è®¤ç›®æ ‡
      
      // å°è¯•è§£æå‘½ä»¤è¡Œï¼Œæå–ç›®æ ‡æœåŠ¡å’Œä¸»æœº
      for (let i = 1; i < commandParts.length; i++) {
        if (commandParts[i].includes('://') || ['ssh', 'ftp', 'http-post-form', 'mysql', 'smtp'].includes(commandParts[i])) {
          service = commandParts[i]
          if (i + 1 < commandParts.length && !commandParts[i + 1].startsWith('-')) {
            target = commandParts[i + 1]
          }
          break
        }
      }
      
      // æå–æ˜¯å¦æœ‰ç”¨æˆ·åå’Œå¯†ç 
      const hasLoginFile = commandParts.includes('-L')
      const hasPassFile = commandParts.includes('-P')
      const hasLogin = commandParts.includes('-l')
      const hasPass = commandParts.includes('-p')
      
      if (!(hasLoginFile || hasLogin) || !(hasPassFile || hasPass)) {
        typeOutput([
          'é”™è¯¯: ç¼ºå°‘ç”¨æˆ·åæˆ–å¯†ç åˆ—è¡¨',
          'ä½¿ç”¨ -l LOGIN æˆ– -L FILE æŒ‡å®šç”¨æˆ·å',
          'ä½¿ç”¨ -p PASS æˆ– -P FILE æŒ‡å®šå¯†ç '
        ])
        return
      }
      
      // å¼€å§‹æ¨¡æ‹Ÿæš´åŠ›ç ´è§£
      typeOutput([
        'Hydra v9.3 (c) 2022 by van Hauser/THC & David Maciejak',
        `æ­£åœ¨å¯åŠ¨å¯¹ ${target} ${service} æœåŠ¡çš„æš´åŠ›ç ´è§£...`,
        '[æ•°æ®] æœ€å¤§ä»»åŠ¡æ•°: 16',
        `[æ•°æ®] å¯èƒ½çš„ç™»å½•å: ${hasLoginFile ? 'ä»æ–‡ä»¶åŠ è½½' : 'æŒ‡å®šçš„ç”¨æˆ·å'} (${Math.floor(Math.random() * 20) + 1}ä¸ª)`,
        `[æ•°æ®] å¯èƒ½çš„å¯†ç : ${hasPassFile ? 'ä»æ–‡ä»¶åŠ è½½' : 'æŒ‡å®šçš„å¯†ç '} (${Math.floor(Math.random() * 1000) + 100}ä¸ª)`,
        '[æ•°æ®] ç›®æ ‡ç«¯å£: é»˜è®¤',
        ''
      ], 100, false)
      
      // æ¨¡æ‹Ÿç ´è§£è¿‡ç¨‹
      let attackDuration = 5  // æ¨¡æ‹Ÿçš„æ”»å‡»æŒç»­ç§’æ•°
      let updateInterval = 500  // æ¯500msæ›´æ–°ä¸€æ¬¡çŠ¶æ€
      let attemptCount = 0
      
      const updateProgress = setInterval(() => {
        attackDuration -= updateInterval / 1000
        attemptCount += Math.floor(Math.random() * 10) + 1
        
        setOutput(prev => [...prev.slice(0, -1), `[çŠ¶æ€] ${attemptCount} å°è¯•å®Œæˆ`])
        
        if (attackDuration <= 0) {
          clearInterval(updateProgress)
          
          // æ ¹æ®ç›®æ ‡å†³å®šæ˜¯å¦ç ´è§£æˆåŠŸ
          if (target === targetSystem.ip || target.includes('test') || Math.random() > 0.7) {
            typeOutput([
              '[21:58:43] [æˆåŠŸ] ç›®æ ‡ ' + target + ' - ç™»å½•: "admin" å¯†ç : "password123"',
              '1 ä¸ªæœ‰æ•ˆçš„å¯†ç ç»„åˆå·²æ‰¾åˆ°',
              ''
            ])
          } else {
            typeOutput([
              'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ç™»å½•/å¯†ç å¯¹',
              ''
            ])
          }
        }
      }, updateInterval)
    } else {
      // å¤„ç†æœªçŸ¥å‘½ä»¤
      typeOutput([
        `æœªæ‰¾åˆ°å‘½ä»¤: ${command}`,
        'ğŸ’¡ è¾“å…¥ "help" æŸ¥çœ‹å¯ç”¨å‘½ä»¤æˆ– "tools" æŸ¥çœ‹æ¸—é€æµ‹è¯•å·¥å…·'
      ])
    }
  }

  return (
    <div className="bg-black rounded-lg overflow-hidden shadow-xl">
      {/* ç»ˆç«¯æ ‡é¢˜æ  */}
      <div className="bg-[#1e1e1e] px-4 py-2 flex items-center">
        <div className="flex space-x-2">
          <div className="w-3 h-3 rounded-full bg-red-500"></div>
          <div className="w-3 h-3 rounded-full bg-yellow-500"></div>
          <div className="w-3 h-3 rounded-full bg-green-500"></div>
        </div>
        <div className="text-white text-xs mx-auto">kali@pentest-terminal: ~</div>
      </div>
      
      {/* ç»ˆç«¯å†…å®¹ */}
      <div 
        ref={terminalRef}
        className="h-96 p-3 overflow-auto font-mono text-sm bg-black"
        onClick={activateTerminal}
        style={{ overflowY: 'scroll', scrollbarWidth: 'thin' }}
      >
        {output.map((line, i) => (
          <div key={i} className="whitespace-pre-wrap break-all">
            {i === output.length - 1 ? (
              <>
                <span className="text-red-500">{line}</span>
                <span className="text-white">{input}</span>
                {isActive && <span className="inline-block w-2 h-4 bg-green-500 ml-0.5 animate-pulse"></span>}
              </>
            ) : line.startsWith('â”Œâ”€â”€') ? (
              <span className="text-red-500">{line}</span>
            ) : line.startsWith('â””â”€') ? (
              <span className="text-red-500">{line}</span>
            ) : line.startsWith('â”‚ ğŸ’¡') ? (
              <span className="text-yellow-300 font-bold">{line}</span>
            ) : line.startsWith('â”‚') ? (
              <span className="text-cyan-400">{line}</span>
            ) : line.includes('æç¤º:') || line.includes('é”™è¯¯:') ? (
              <span className="text-yellow-300 font-bold">{line}</span>
            ) : line.includes('[æˆåŠŸ]') || line.includes('å‘ç°:') || line.includes('å·²æ£€æµ‹æ¼æ´:') ? (
              <span className="text-green-400">{line}</span>
            ) : line.includes('[INFO]') ? (
              <span className="text-blue-400">{line}</span>
            ) : line.includes('[WARNING]') ? (
              <span className="text-yellow-400">{line}</span>
            ) : line.includes('[çŠ¶æ€]') ? (
              <span className="text-blue-300">{line}</span>
            ) : line.includes('msf6') ? (
              <span className="text-red-400">{line}</span>
            ) : (
              <span className="text-white">{line}</span>
            )}
          </div>
        ))}
        
        {!isActive && (
          <div className="absolute inset-0 flex items-center justify-center bg-black/50 text-white cursor-pointer">
            <span className="px-4 py-2 bg-green-600 rounded text-sm animate-pulse">ç‚¹å‡»æ­¤å¤„æ¿€æ´»æ¸—é€æµ‹è¯•ç»ˆç«¯</span>
          </div>
        )}
      </div>
      
      {/* éšè—çš„è¾“å…¥æ¡† */}
      <input
        ref={inputRef}
        type="text"
        className="opacity-0 absolute -z-10"
        value={input}
        onChange={(e) => {
          // ä¿å­˜æ»šåŠ¨ä½ç½®
          const scrollPos = window.scrollY
          setInput(e.target.value)
          // é˜²æ­¢è¾“å…¥å¯¼è‡´é¡µé¢æ»šåŠ¨
          requestAnimationFrame(() => {
            window.scrollTo({
              top: scrollPos,
              behavior: 'auto'
            })
          })
        }}
        onKeyDown={handleKeyDown}
      />
    </div>
  )
}

export default PentestTerminal 